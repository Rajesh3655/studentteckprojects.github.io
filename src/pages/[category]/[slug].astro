---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { Category, Opportunity } from "../../types";
import { categoryLabel, canonicalPath, formatDate, loadCategory, loadDetail } from "../../lib/opportunities";

export function getStaticPaths() {
  const categories: Category[] = ["jobs", "projects", "internships", "hackathons"];
  return categories.flatMap((category) =>
    loadCategory(category).map((item) => ({
      params: { category, slug: item.slug },
      props: { category, item }
    }))
  );
}

const { category, item } = Astro.props as { category: Category; item: Opportunity };
const detail = loadDetail(item.slug);
const title = `${item.title} - ${item.company}`;
const description = item.excerpt || detail.intro || `Details for ${item.title}.`;
const canonical = canonicalPath(category, item.slug);
const pageType = category === "projects" ? "Article" : "JobPosting";
const responsibilities = Array.isArray(detail.responsibilities) ? (detail.responsibilities as string[]) : [];
const minQualifications = Array.isArray(detail.minQualifications) ? (detail.minQualifications as string[]) : [];
const prefQualifications = Array.isArray(detail.prefQualifications) ? (detail.prefQualifications as string[]) : [];
const projectModules = Array.isArray(detail.projectModules)
  ? (detail.projectModules as Array<{ name?: string; description?: string }>)
  : [];
const futureEnhancements = Array.isArray(detail.futureEnhancements) ? (detail.futureEnhancements as string[]) : [];
const jsonLd = {
  "@context": "https://schema.org",
  "@type": pageType,
  headline: item.title,
  name: item.title,
  description,
  datePosted: item.postedDate,
  hiringOrganization: {
    "@type": "Organization",
    name: item.company
  },
  employmentType: item.type,
  jobLocation: {
    "@type": "Place",
    address: {
      "@type": "PostalAddress",
      addressLocality: item.location || "Not specified"
    }
  },
  url: `https://studenttechprojects.com${canonical}`
};
---
<BaseLayout title={title} description={description} canonicalPath={canonical}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <div class="breadcrumbs">
    <a href="/">Home</a> / <a href={canonicalPath(category)}>{categoryLabel(category)}</a> / {item.title}
  </div>

  <h1>{item.title}</h1>
  <p class="muted company">{item.company}</p>
  <p class="muted">{item.location || "Not specified"} â€¢ Published on {formatDate(item.postedDate)}</p>

  {detail.image && <img src={detail.image as string} alt={(detail.imageAlt as string) || item.title} style="max-width: 100%; border-radius: 12px; border: 1px solid #e5e7eb;" loading="lazy" />}

  <div class="stack detail">
    <section class="card">
      <h2>Overview</h2>
      <p>{detail.intro || item.excerpt || "Visit official listing for full details."}</p>
      <p><strong>Type:</strong> {categoryLabel(category)}</p>
      <p><strong>Qualification:</strong> {item.qualification || "Not specified"}</p>
      <p><strong>Experience:</strong> {item.experience || "Not specified"}</p>
      <p><strong>Batch:</strong> {item.batch || "Not specified"}</p>
      <p><strong>Salary:</strong> {item.salary || "Not specified"}</p>
      <p><strong>Last Date:</strong> {detail.lastDate ? formatDate(detail.lastDate as string) : "Not specified"}</p>
    </section>

    {detail.jobDescription && (
      <section class="card">
        <h2>Description</h2>
        <p>{detail.jobDescription as string}</p>
      </section>
    )}

    {responsibilities.length > 0 && (
      <section class="card">
        <h2>Responsibilities</h2>
        <ul>
          {responsibilities.map((point) => <li>{point}</li>)}
        </ul>
      </section>
    )}

    {minQualifications.length > 0 && (
      <section class="card">
        <h2>Minimum Qualifications</h2>
        <ul>
          {minQualifications.map((point) => <li>{point}</li>)}
        </ul>
      </section>
    )}

    {prefQualifications.length > 0 && (
      <section class="card">
        <h2>Preferred Qualifications</h2>
        <ul>
          {prefQualifications.map((point) => <li>{point}</li>)}
        </ul>
      </section>
    )}

    {category === "projects" && projectModules.length > 0 && (
      <section class="card">
        <h2>Project Modules</h2>
        <ul>
          {projectModules.map((mod) => (
            <li><strong>{mod.name || "Module"}:</strong> {mod.description || "Details in official project note."}</li>
          ))}
        </ul>
      </section>
    )}

    {category === "projects" && futureEnhancements.length > 0 && (
      <section class="card">
        <h2>Future Enhancements</h2>
        <ul>
          {futureEnhancements.map((point) => <li>{point}</li>)}
        </ul>
      </section>
    )}

    <section class="card">
      <h2>How To Apply</h2>
      <p>{(detail.howToApply as string) || "Use the official apply link below."}</p>
      {item.applyLink && <a class="btn" href={item.applyLink} target="_blank" rel="noopener noreferrer">Apply Now</a>}
    </section>

    <section class="softsite">
      <img src="https://www.google.com/s2/favicons?domain=softsitesolution.in&sz=128" alt="SoftSiteSolution icon" />
      <p><strong>Need help to start a business project?</strong></p>
      <p>Contact SoftSiteSolution for project guidance and development support.</p>
      <a class="btn" href="https://www.softsitesolution.in" target="_blank" rel="noopener noreferrer">www.softsitesolution.in</a>
    </section>
  </div>
</BaseLayout>
